using System;
using System.Linq;
using Contests.Common;
using FluentAssertions;
using NUnit.Framework;

namespace Contests.Tasks.AdventOfCode2020
{
    public static class Task3
    {
        public static int CountTrees(string[] maze, int dx, int dy)
        {
            var x = 0;
            var y = 0;
            var treeCount = 0;
            while (y <= maze.Length - 1)
            {
                if (maze[y][x] == '#')
                {
                    maze[y] = maze[y].ReplacePosition('X', x);
                    treeCount++;
                }
                else
                {
                    maze[y] = maze[y].ReplacePosition('O', x);
                }

                x += dx;
                y += dy;
            }

            return treeCount;
        }
    }

    public class Task3Tests
    {
        [Test]
        public void TestExample()
        {
            var x = Assert(ExamplePattern, 1, 1, 2);
            x *= Assert(ExamplePattern, 5, 1, 3);
            x *= Assert(ExamplePattern, 7, 1, 4);
            x *= Assert(ExamplePattern, 1, 2, 2);
            x *= Assert(ExamplePattern, 3, 1, 7);
            x.Should().Be(336);
        }

        [Test]
        public void TestFullOfTrees()
        {
            Assert(FullOfTreesPatternEven, 1, 1, 2);
            Assert(FullOfTreesPatternEven, 1, 2, 1);
            Assert(FullOfTreesPatternOdd, 1, 1, 3, 201);
            Assert(FullOfTreesPatternOdd, 1, 2, 2, 201);
        }

        [Test]
        public void TestTask()
        {
            var x = Assert(TaskPattern, 1, 1, 79);
            x *= Assert(TaskPattern, 3, 1, 234);
            x *= Assert(TaskPattern, 5, 1, 72);
            x *= Assert(TaskPattern, 7, 1, 91);
            x *= Assert(TaskPattern, 1, 2, 48) + 1;
            Console.WriteLine(x);
        }

        private static int Assert(string[] pattern, int dx, int dy, int expectedTreeCount, int repeatCount = 200)
        {
            var maze = pattern.Select(x => string.Join("", Enumerable.Repeat(x, repeatCount))).ToArray();

            var countTrees = Task3.CountTrees(maze, dx, dy);

            Console.WriteLine($"Maze for dx={dx} dy={dy}");
            foreach (var str in maze)
                Console.WriteLine(str);
            countTrees.Should().Be(expectedTreeCount, $"dx={dx} dy={dy}");
            return countTrees;
        }

        private static readonly string[] ExamplePattern =
        {
            "..##.......",
            "#...#...#..",
            ".#....#..#.",
            "..#.#...#.#",
            ".#...##..#.",
            "..#.##.....",
            ".#.#.#....#",
            ".#........#",
            "#.##...#...",
            "#...##....#",
            ".#..#...#.#"
        };

        private static readonly string[] FullOfTreesPatternOdd =
        {
            "#",
            "#",
            "#"
        };

        private static readonly string[] FullOfTreesPatternEven =
        {
            "#",
            "#"
        };

        private static readonly string[] TaskPattern =
        {
            ".......#..#....#...#...#......#", "..##..#...##.###.#..#.....#.#..", "#..#.#....#......#..#.........#",
            ".#..##...#........#....#..#..#.", "#.#.#....###...#........#.....#", ".#...#.#.##.#.##...#.#.........",
            "####......#.......###.##.#.....", "..#...........#...#.#.#........", ".#.......#....###.####..#......",
            "...##........#....##.......##..", ".###......##.#......##....#.#.#", "........#.#......##...#......#.",
            "#....##.#..#...#.......#.......", ".#..##........##.........#....#", ".#..#..#...#....#.#......#.#...",
            "..#.#......##.#.......#....##..", "......##......#.#..##.#..#...#.", ".....##.......#.#....#.#.......",
            "........#.....#.....#..###.#...", "#........#..#.....#...#.#.#..#.", ".#..#.....#...#........#.....#.",
            ".#.#.....#.....#...#...........", ".....#.#..#..#...#..#..#..##..#", "##.#...#....#..#.##..#.....#.#.",
            "#.......####......#..#.#....#..", "......#.#...####.........#.#..#", ".#.........#..#.#...#..........",
            "...#####.#....#.#..#......#.#.#", "##....#.###....##...##..#.....#", "...........####.##.#....##.##..",
            "#.#.#..........#.#..##.#.######", "##...#..#...........###..#....#", ".#.#.#...##..........##.#...#..",
            "...#.#........#..##...#....#...", "......#..#...#..##....#.......#", ".#..#.......#..#......##....##.",
            ".......#.......#........#..##..", "...#...#...#.##......#.##.#....", ".........#.........#.#.#.##....",
            "..#...................#....#..#", ".........#..#.....#.#...#....#.", "#.#.#...#........#..###.#......",
            "#.#.#.####......##...#...#....#", "#...........##..#.#.#....#..#..", "........#..#.#...........##.#.#",
            ".#.........#...........#..#....", "#............##.#..#....##...##", ".#....##..#.#....#.......#..#..",
            "..#.#...#.#......####.......#..", "...#.#.......###......#.....#..", "#......#.......#.#...#.#..##...",
            "...#.....#...##.#.....#.#......", "#.#.#............#..#......#..#", "....#...#...##.##.##...##.#....",
            "..##........#..#........#...##.", ".......#..#...#.........#.....#", "...........#.#......#...#......",
            "...##..##..##..###..#..#..#..#.", "#..##.......##..#....#....#.#..", "#.#.##.#..##.....#....#.#......",
            "....#..##......#.#..#....#....#", ".#.#.........##...#......##.##.", "##...........#..#.....#.###....",
            ".#.###........#...#....##..#...", "......##.....#.................", ".#.##..#.#.......#......#.#.#..",
            ".#...#....#.##..........##.##..", "#...##......####.#....#....#...", ".#...#.##.#.#.....#...#........",
            ".#................#.##.#.###...", "...#.#..#.#.....##.....##....#.", "..##.#..#..##.....#....#...#.##",
            "........###.##..#..###.....#..#", "..##.....#.......#.#...##......", "#.#..###...##.###.##.#..#...#..",
            "#..#..#.#...#....#...##.....#.#", "#..................#........#..", "#.....#.......#.##....##....#..",
            "...#.............#.....#...#...", "...#...#.##..##.....#........#.", ".......#........##....###..##..",
            ".#....#....#.#..#......#....#.#", "..........#..#.#.....##...#.##.", ".#...##.#...........#.#.......#",
            "..#.##.....#.###.#.............", "..#....###..........#.#.#......", "#.....#.####..#.#......#..#.#.#",
            "...#........#..#...............", ".###.#.##.....#.#...........#..", "..#....#..#....#..##....#......",
            "......#..#.....#.#.##.......#.#", "###..#...#.#..#....#..##.###..#", ".#....##.###........##...##.#.#",
            "........##..##.#....##..#....#.", "...#..#....#.#....#...#...##...", "#.....#......#.##........#....#",
            "....#....###.##...#.#.##....#..", "......#.##..#.#..........#...#.", "...........#...#....##...#....#",
            "......#.#.........#....#.#.#...", ".###..........#.###.##....#...#", "...##.......#......#....#....#.",
            "#..#...#.#..####...#......#..#.", "....##..#.#.........#..........", ".##.###.##....##.####....#...#.",
            "..##.......#........#...#..#...", "....#####..........###....#....", ".#.#..#.#.#....#..#............",
            "........#.....#....#.......##..", "...........##....##..##.....##.", "..###........#.#.#..#....##...#",
            ".....#...........##......#..#..", "...##........#.##.#......##..#.", "##..#....#............##..#..#.",
            ".#.....#...##.##..............#", "#..##........#...#...#......##.", "......##.....#.......####.##..#",
            "...#.#....#...#..#.............", "..#...#..##.###..#..#.......##.", "##....###.......#...#..#.......",
            "#..#.....###.....#.#.........#.", "#.#....#.............#...#.....", "..#.#.##..........#.....##.#...",
            ".....##......#..#..#.....#..#..", "##.#..#..#.##......###....#..#.", "...#............##...#..##.....",
            ".#..#....#.........#......#.##.", ".##.##...#..............#..#.##", "...#....#...###...#...#....#..#",
            "..#...#..####..#....#.#...##..#", "..............##.##.......##...", "..##.#..##...........#.#.#...#.",
            "..................##.####.###..", ".#...........#.......#......#..", ".#.#.#...#....#.........##...##",
            "....#..........#.#....#.#.....#", "..........#.#..........#.#.....", "...........#.....#.#......#....",
            "........#..#.#.#.#.............", "...###...##...##..####.##......", ".#..#......###.....#...#.....#.",
            ".........##............#.#.....", "#.#..#.#.#....###.#.#..#..#..##", "..........#...#.##.#..#..#....#",
            "#..#.......##....#..##........#", "##.#...#....##.............#...", "....#........#......##..#..#.##",
            ".................#.#.#.#.#.....", "...........#.#.....#.......#...", "#.......#.......#............#.",
            "....#...........#.#.##.....#..#", "#...#.....#....#..##...#.......", "..#.....#.....#.##.##....#.....",
            ".#.#..#...#..#..##.....##..#...", ".#.#....#.........####.........", "#...#..####.....#...#..##......",
            "..#...##.#.....#...#.....##....", ".#...#.....#.#.#......#.......#", "..#.....##.#..#.#...##.........",
            "##.#...#..#....#....#.##.##...#", ".#..#....#..##.#.......#..#....", "...##.#......#...###.......#...",
            "...#..#.........##.####........", "#.#..#..##...........#..#......", ".#...#.#......#.#..........#...",
            "...###...#.......#.....#.#...##", "..#....#.#.##..........##...#..", ".....###.........#.....#..##..#",
            ".......##.....#.#.....#.#..##..", ".#.#.###..##.......##...#......", "......#.....#................##",
            ".#......##..##.#.#...#...#...##", ".#...#......#.......#.#........", ".#..........###...#..#...#.....",
            ".........##.....#.#..#..#.#...#", "#...#...#.........#..#..#....#.", "###.......#.#.....#....##......",
            ".#..#......#..#...........#..#.", "..##....##..##...#......#......", ".#........#....#...#....#.....#",
            ".#.......#...#...#..##.#.#..#..", "#...#........#.##.....#.....#..", "#..##.....#..........#...#...##",
            "............#...............#..", ".#.##...#.....#.#..#..#..#.....", ".#.#.#...#........#....#...##..",
            "##......#.....#.###.#...#.#..#.", ".........##..#..#.#...#...#...#", "#...#.#....#..#..#.....#.......",
            ".......#.###...#.............#.", "..#.....#.#.#..###.#....#.....#", "....#...#.#....#.#..........#..",
            "..#......#.###.#.#..#.....#...#", "#............#..##...##......#.", "#...........#..#....#.###..###.",
            ".#.##.#.#.......#.............#", "..............#................", "..#.#.....#.....#...#......#...",
            ".#.#.#..#..#.#...........##....", ".....##.#......#..#.##....#....", ".......##..#.#.#..#............",
            "..#.....#.....#.###..#.....#.#.", "......##.....#..##.#...#.....#.", "...#...#....#..#..#........#...",
            "..#.##..#....#.........#.#..#..", "#....#.....###.....#......#....", "##.....#..#..##.........#.##.##",
            ".#.#....#.#..........#.........", ".##.#...#..#.......#.##...#....", "...#...#.....#....#...#.#..#...",
            ".....#....#.....#.....#.#......", "...........#.#.......#.......#.", ".........##.###.##........#....",
            "#..##.....#...#.#..............", ".#...#....##........#.#..#....#", "..#...#........#...#..#.##.#..#",
            "........#...#.....##.#.#....#.#", "#..#.......###.#....#.#.#......", ".......#...##....#...#..##..#..",
            ".....##........#.#.#..#....##..", ".#....#..#.#...........#......#", "...##....#.##.....##.......#...",
            ".##..#..#....#.#....#..#....##.", "..#....#.....###.......#..##..#", "....#.......#....##..#....#..##",
            "....#......##..#....#.#...#.#..", ".##.#......##..................", "##.#....#........#..#..#...##.#",
            ".......#..#.#...##.....#.#.....", "..##.#...........#.#.#..#.#.#..", ".....#....#......#..#.......#..",
            "#.#...#.####..##.......#..##...", "...#....#.....#.##.#..#.##..#..", ".#.......#......##........##.#.",
            ".......#.#...#..#...#..##.#....", ".#....#........#.#.....##..#..#", "#..#.....#..#.............#...#",
            "#...#....#..#...###..#...#.#...", ".#..#.....#..........#..##.####", "#.#.#.#.##.#.#.....##.#........",
            "...#....##....#...#..##.......#", "..##.##.#.#........#..........#", "..###........###..#..........#.",
            "...#......#..##.#........#..#..", "#.#.#..#........#..#..........#", "...#........#..##.#...#.###....",
            "##......#.####.#....#......#...", ".#..#......#................#..", "#.#........#.#.....##.....##...",
            "#...............#..#.......#.#.", ".##..#...........##..#..#.#....", "#......#.#.......#.#.#.##..#.##",
            ".....##.#..###.............##..", "....##.........#..#...#........", ".....#.....#.#.#..#.#..........",
            "#.........#....##.#.##.....#..#", ".#.........#......#.#.##.#.#...", "##.........#.....#..#.#..#.##.#",
            "....#......##...#.....#..#..###", "..#..............#...#..####...", "#....#...##.#.......#...#..#...",
            "#.......###.#.#.......#.......#", "...##....#.#...........#...###.", "...........#..#.#.....#..##..#.",
            "..#.........#..###..#.....#...#", "..#.#.....#.#.#...#.#.#......#.", "........#.....#.#......##....##",
            "##.#.#...#.#........#.....#...#", "........#....#...............#.", "##.###......####...#####..#....",
            "...##...#..#....#........#...#.", "...###.#..................##.#.", "##.#.......###.......#...#.#...",
            "....#..#.#...#...#....#.#.#..##", "....#...........#..#...........", "#..#.#..#...#...#..#...........",
            "...#...#.#....#..#....#........", "#....#.......#.##........#..#..", ".....#...#..#................#.",
            "#......#.......#..........##..#", ".#....#.#......#.#...#....##..#", "...#.##...#......#.#...##...##.",
            "..#...#..##...#...#....#.......", ".....#....#.#.#..........#.#...", "...#...#..#....#..#.#..........",
            "......#.#..........##.......#..", ".#...##.#.#...#..##..#...#.....", "..#..#.........#........#.#.#..",
            "#.#..##..#.....##......#.....#.", "#..#.....#.#....#...#.#....#.#.", "......#........##.#..#...#.....",
            "...#.##.#.#......#.#..##...#..#", "....#..###..#..#.....###....##.", ".....#...#.#.....#..........#.#",
            ".#...##..##.....#..#...#.#.#...", ".##.#......##...##..#...#.....#", ".#.##....#...#.##.#.#...#.#...#",
            "....#.#...#....###.#.....#.....", "#.....####................#..#.", "....#.....#...#.#.......##.#...",
            ".#...##.#...#..#...........#.#.", "..#####..#.#...#...##........#.", "...#...##........#...#.#....###",
            "........#.#.#..#.....#.......#.", "...#...#..##............##.....", "#.#..###....###.#...#.#...##.##",
            "..#.##...#......#..#.........##", ".##..#..#.....#..#.........#.#.", ".#..#.#....#.##...#..#.##....##",
            "..#...#.#...##.#.#...#...#....#", "#..........#.......##..##....#.", "#...###.#......#....#.........#",
            "#.....#...##.......##....##....", ".##.#..#.##......#.##....#..#..", "............#.#....##.#..#....#",
            ".#.........##.##...#....#.....#", "##....##..#..#....##...#.....##", "...#.....#...........#.....##..",
            "......#...#.........#.......#..", "............#...##.#.....#.#.#.", ".#........##..........#.....#.#",
            ".###.........#.....#.##...#....", ".##..#...##...#..#..#.##......."
        };
    }
}